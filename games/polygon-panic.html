<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Polygon Panic</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #111; overflow: hidden; }
    canvas { display: block; margin: auto; }
    #levelupOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7) url("https://houselearning.github.io/home/games/static/levelup.gif") center center no-repeat;
      background-size: contain;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="levelupOverlay"></div>
  <audio id="shootSound" src="https://houselearning.github.io/home/games/static/shoot.mp3"></audio>
  <audio id="levelupSound" src="https://houselearning.github.io/home/games/static/levelup.mp3"></audio>
  <audio id="bgMusic" src="https://houselearning.github.io/home/games/static/game.mp3" loop></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 600;
canvas.height = 800;

let player = {
  x: canvas.width / 2,
  y: canvas.height - 50,
  size: 30,
  speed: 7
};

let keys = {};
let bullets = [];
let polygons = [];
let bosses = [];
let score = 0;
let gameOver = false;
let level = 1;
let lastLevel = 1;

const shootSound = document.getElementById("shootSound");
const levelupSound = document.getElementById("levelupSound");
const levelupOverlay = document.getElementById("levelupOverlay");
document.getElementById("bgMusic").play();

const backgroundImages = [
  new Image(), new Image(), new Image(), new Image(), new Image()
];
backgroundImages[0].src = "https://houselearning.github.io/home/games/static/level1.gif";
backgroundImages[1].src = "https://houselearning.github.io/home/games/static/level2.gif";
backgroundImages[2].src = "https://houselearning.github.io/home/games/static/level3.gif";
backgroundImages[3].src = "https://houselearning.github.io/home/games/static/level4.gif";
backgroundImages[4].src = "https://houselearning.github.io/home/games/static/level5.gif";

document.addEventListener("keydown", (e) => {
  keys[e.key] = true;
  if (e.key === " ") shoot();
});
document.addEventListener("keyup", (e) => keys[e.key] = false);

function shoot() {
  bullets.push({ x: player.x, y: player.y, radius: 5, speed: 10 });
  shootSound.currentTime = 0;
  shootSound.play();
  score += 75;
}

function drawPlayer() {
  ctx.fillStyle = "#0ff";
  ctx.beginPath();
  ctx.moveTo(player.x, player.y);
  ctx.lineTo(player.x - player.size, player.y + player.size);
  ctx.lineTo(player.x + player.size, player.y + player.size);
  ctx.closePath();
  ctx.fill();
}

function drawPolygon(x, y, radius, sides, rotation = 0, color = "#f0f") {
  const angle = (Math.PI * 2) / sides;
  ctx.beginPath();
  for (let i = 0; i < sides; i++) {
    const px = x + radius * Math.cos(i * angle + rotation);
    const py = y + radius * Math.sin(i * angle + rotation);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fillStyle = color;
  ctx.fill();
}

function spawnPolygon() {
  const sides = Math.floor(Math.random() * 5) + 3;
  const radius = Math.random() * 20 + 20;
  const x = Math.random() * (canvas.width - radius * 2) + radius;
  const y = -radius;
  const speed = Math.random() * 2 + getLevelData(score).polygonSpeed;
  polygons.push({ x, y, radius, sides, speed });
}

function spawnBoss() {
  const radius = 40;
  const sides = 6;
  const x = Math.random() * (canvas.width - radius * 2) + radius;
  const y = -radius;
  const speed = 2;
  bosses.push({ x, y, radius, sides, speed, health: 10, maxHealth: 10 });
}

function drawHealthBar(boss) {
  ctx.fillStyle = "#000";
  ctx.fillRect(boss.x - 30, boss.y - boss.radius - 10, 60, 6);
  ctx.fillStyle = "#f00";
  ctx.fillRect(boss.x - 30, boss.y - boss.radius - 10, 60 * (boss.health / boss.maxHealth), 6);
}

function getLevelData(score) {
  if (score >= 30000) return { level: 5, spawnRate: 200, polygonSpeed: 7 };
  if (score >= 25000) return { level: 4, spawnRate: 300, polygonSpeed: 6 };
  if (score >= 10000) return { level: 3, spawnRate: 400, polygonSpeed: 5 };
  if (score >= 1000) return { level: 2, spawnRate: 500, polygonSpeed: 4 };
  return { level: 1, spawnRate: 600, polygonSpeed: 3 };
}

function update() {
  if (keys["ArrowLeft"]) player.x -= player.speed;
  if (keys["ArrowRight"]) player.x += player.speed;
  player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));

  bullets.forEach(b => b.y -= b.speed);
  bullets = bullets.filter(b => b.y > 0);

  polygons.forEach(p => p.y += p.speed);
  polygons = polygons.filter(p => p.y - p.radius < canvas.height);

  bosses.forEach(b => b.y += b.speed);

  for (let p of polygons) {
    const dx = player.x - p.x;
    const dy = (player.y + player.size / 2) - p.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < p.radius + player.size / 2) gameOver = true;
  }

  for (let boss of bosses) {
    const dx = player.x - boss.x;
    const dy = (player.y + player.size / 2) - boss.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (dist < boss.radius + player.size / 2) gameOver = true;
  }

  bullets.forEach((bullet, i) => {
    polygons.forEach((p, j) => {
      const dx = bullet.x - p.x;
      const dy = bullet.y - p.y;
      if (Math.sqrt(dx * dx + dy * dy) < bullet.radius + p.radius) {
        polygons.splice(j, 1);
        bullets.splice(i, 1);
      }
    });

    bosses.forEach((boss, j) => {
      const dx = bullet.x - boss.x;
      const dy = bullet.y - boss.y;
      if (Math.sqrt(dx * dx + dy * dy) < bullet.radius + boss.radius) {
        boss.health--;
        bullets.splice(i, 1);
        if (boss.health <= 0) {
          bosses.splice(j, 1);
          score += 500;
        }
      }
    });
  });

  let newLevel = getLevelData(score).level;
  if (newLevel !== lastLevel) {
    lastLevel = newLevel;
    level = newLevel;
    levelupOverlay.style.display = "block";
    levelupSound.play();
    setTimeout(() => levelupOverlay.style.display = "none", 2000);
  }

  if (Math.random() < 0.002 * level) spawnBoss();
}

function draw() {
  const bg = backgroundImages[level - 1];
  if (bg.complete) ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
  else ctx.fillStyle = "#000", ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawPlayer();

  polygons.forEach(p => drawPolygon(p.x, p.y, p.radius, p.sides));
  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
    ctx.fillStyle = "#f00";
    ctx.fill();
  });

  bosses.forEach(b => {
    drawPolygon(b.x, b.y, b.radius, b.sides, 0, "#ff0");
    drawHealthBar(b);
  });

  ctx.fillStyle = "#fff";
  ctx.font = "20px monospace";
  ctx.fillText("Score: " + score, 20, 30);
  ctx.fillText("Level: " + level, canvas.width - 120, 30);
}

function loop() {
  if (!gameOver) {
    update();
    draw();
    requestAnimationFrame(loop);
  } else {
    ctx.fillStyle = "#fff";
    ctx.font = "48px sans-serif";
    ctx.fillText("Game Over!", canvas.width / 2 - 130, canvas.height / 2);
    ctx.font = "24px monospace";
    ctx.fillText("Final Score: " + score, canvas.width / 2 - 90, canvas.height / 2 + 40);
  }
}

let currentSpawnRate = 600;
let spawnTimer = setInterval(spawnPolygon, currentSpawnRate);
setInterval(() => {
  const levelData = getLevelData(score);
  if (levelData.spawnRate !== currentSpawnRate) {
    clearInterval(spawnTimer);
    currentSpawnRate = levelData.spawnRate;
    spawnTimer = setInterval(spawnPolygon, currentSpawnRate);
  }
}, 100);

loop();
</script>
</body>
</html>
